# TikTok Shop API 授权流程说明

## 概述

这是一个重新设计的分步骤授权流程工具，按照 `auth_code → access_token → shop_cipher` 的逻辑顺序，提供清晰的用户体验。

## 文件结构

```
public/
├── index.html                      # 主入口页面，显示授权流程进度
├── step1-auth-code.html            # 步骤1: 获取授权码
├── step2-access-token.html         # 步骤2: 换取访问令牌
├── step3-shop-cipher.html          # 步骤3: 获取店铺标识
├── dashboard.html                  # API测试仪表板
└── test-api.html                   # 旧版单页面工具（保留）
```

## 授权流程

### 步骤 1: 获取授权码 (step1-auth-code.html)

**功能:**
- 生成 TikTok Shop OAuth 授权链接
- 自动复制授权链接到剪贴板
- 用户在浏览器中打开链接完成授权
- 输入从回调URL中获取的 `code` 参数

**操作:**
1. 点击"获取授权链接"按钮
2. 复制生成的链接在新窗口打开
3. 完成 TikTok 授权
4. 从回调URL的 `code` 参数中获取授权码
5. 将授权码粘贴到输入框
6. 点击"保存并进入下一步"

**数据传递:**
- `auth_code`: 通过URL参数传递到步骤2
- `api_base_url`: API基础URL配置

### 步骤 2: 换取访问令牌 (step2-access-token.html)

**功能:**
- 使用授权码换取 `access_token`
- 显示Token信息（access_token, refresh_token, 过期时间）
- 支持刷新Token功能

**操作:**
1. 确认授权码已自动填充
2. 点击"换取访问令牌"按钮
3. 查看返回的Token信息
4. 点击"进入下一步"

**数据传递:**
- `access_token`: 通过URL参数传递到步骤3
- `api_base_url`: 继续传递API配置

**Token信息:**
- `access_token`: 有效期7天，用于API调用
- `refresh_token`: 用于刷新过期的access_token
- `access_token_expire_in`: 过期时间（秒）

### 步骤 3: 获取店铺标识 (step3-shop-cipher.html)

**功能:**
- 使用access_token获取已授权的店铺列表
- 显示所有店铺信息（ID、名称、地区、cipher）
- 选择要操作的店铺

**操作:**
1. 确认access_token已自动填充
2. 点击"获取已授权店铺列表"
3. 从列表中选择一个店铺
4. 点击"进入 API 测试仪表板"

**数据传递:**
- `access_token`: 继续传递到仪表板
- `shop_cipher`: 选中的店铺cipher
- `shop_id`: 店铺ID
- `shop_name`: 店铺名称
- `shop_region`: 店铺地区
- `api_base_url`: API配置

### API 测试仪表板 (dashboard.html)

**功能:**
- 完整的API测试界面
- 三个主要模块：店铺管理、产品管理、订单管理
- 实时显示认证状态

**模块:**

**1. 店铺管理:**
- 获取已授权店铺列表
- 获取店铺详情
- 获取店铺权限
- 获取Widget Token

**2. 产品管理:**
- 搜索产品（全部/已激活/草稿）
- 获取产品详情
- 创建产品
- 激活/停用/删除产品
- 更新库存和价格
- 获取分类和品牌列表

**3. 订单管理:**
- 按状态获取订单（待发货/运输中/已完成）
- 获取订单详情
- 高级搜索订单
- 获取最近更新的订单

## 技术特点

### 1. 无localStorage依赖
- 所有数据通过URL参数传递
- 避免敏感信息长期存储在浏览器
- 关闭窗口后自动清除

### 2. 清晰的流程引导
- 每个步骤都有明确的说明
- 进度指示器显示当前阶段
- 自动填充上一步的数据

### 3. 错误处理
- API调用错误详细显示
- 缺少必要参数时给出提示
- 自动重定向到正确的步骤

### 4. 响应式设计
- 适配桌面和移动设备
- 美观的渐变色设计
- 流畅的动画效果

## 使用方法

### 启动项目

```bash
# 安装依赖
pnpm install

# 启动开发服务器
pnpm run start:dev
```

### 访问页面

在浏览器中打开: `http://localhost:3000/index.html`

或直接访问: `http://192.168.5.153:3000/index.html`

### 完成授权流程

1. **从 index.html 开始**
   - 查看授权流程进度说明
   - 点击"开始步骤 1"

2. **依次完成三个步骤**
   - 每个步骤完成后自动进入下一步
   - 可以随时返回上一步修改

3. **进入仪表板测试API**
   - 完成步骤3后自动进入仪表板
   - 所有认证信息已自动填充
   - 开始测试各种API功能

## 配置说明

### API Base URL

默认值: `http://192.168.5.153:3000`

可以在以下位置修改:
1. index.html 的配置区域
2. 各步骤页面的API配置输入框
3. dashboard.html 的配置表单

### 环境要求

- Node.js 16+
- 后端服务必须运行
- 网络连接到TikTok API

## 故障排除

### 问题: 未找到授权码

**解决方案:**
- 确保从步骤1的"获取授权链接"开始
- 完成TikTok授权后，从URL中复制`code`参数

### 问题: Token获取失败

**解决方案:**
- 检查授权码是否正确
- 确认API Base URL配置正确
- 查看浏览器控制台的错误信息

### 问题: 无法获取店铺列表

**解决方案:**
- 确认access_token有效
- 检查Token是否已过期
- 尝试刷新Token

### 问题: API调用失败

**解决方案:**
- 确认已选择shop_cipher
- 检查access_token是否过期
- 查看响应区域的详细错误信息

## 安全建议

1. **不要在公网环境暴露**: 确保API Base URL不对外暴露
2. **定期刷新Token**: Token有效期7天，建议定期刷新
3. **保护授权码**: 授权码只能使用一次
4. **关闭后清除**: 关闭浏览器窗口后，所有认证信息自动清除

## 对比旧版

### 旧版 (test-api.html)
- 单页面应用
- 所有功能混在一起
- 用户不知道操作顺序
- localStorage存储敏感信息

### 新版 (分步骤流程)
- 多页面应用
- 清晰的三步骤流程
- 强制按顺序操作
- 无长期存储，更安全

## 后续改进

- [ ] 添加更多API测试功能
- [ ] 支持批量操作
- [ ] 添加请求历史记录
- [ ] 支持导出API响应
- [ ] 添加更多的错误提示
- [ ] 支持多店铺切换

## 联系方式

如有问题或建议，请联系开发团队。
