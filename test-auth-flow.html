<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµ‹è¯•æˆæƒæµç¨‹ - TikTok Shop</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1 {
            color: #333;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            background: #d4edda;
            color: #155724;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #5568d3;
        }
        input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100%;
            margin: 5px 0;
            box-sizing: border-box;
        }
        .log {
            background: #2d3748;
            color: #68d391;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="card">
        <h1>ğŸ§ª æˆæƒæµç¨‹æµ‹è¯•</h1>
        <p>æ­¤é¡µé¢ç”¨äºæµ‹è¯•è‡ªåŠ¨å¤„ç†æˆæƒç å’ŒlocalStorageå­˜å‚¨åŠŸèƒ½</p>
    </div>

    <div class="card">
        <h2>å½“å‰çŠ¶æ€</h2>
        <div id="status" class="status info">æ£€æŸ¥ä¸­...</div>
    </div>

    <div class="card">
        <h2>æµ‹è¯•åŠŸèƒ½</h2>
        <button onclick="simulateAuthCallback()">æ¨¡æ‹Ÿæˆæƒå›è°ƒ(?code=test_code_12345)</button>
        <button onclick="showLocalStorage()">æŸ¥çœ‹localStorage</button>
        <button onclick="clearLocalStorage()">æ¸…é™¤localStorage</button>
        <button onclick="testTokenExpiry()">æµ‹è¯•Tokenè¿‡æœŸæ£€æŸ¥</button>
    </div>

    <div class="card">
        <h2>æ‰‹åŠ¨æµ‹è¯•</h2>
        <input type="text" id="testCode" placeholder="è¾“å…¥æµ‹è¯•æˆæƒç ">
        <button onclick="manualGetToken()">æ‰‹åŠ¨è·å–Token</button>
    </div>

    <div class="card">
        <h2>æ—¥å¿—</h2>
        <div id="log" class="log">ç­‰å¾…æ“ä½œ...</div>
    </div>

    <script>
        const STORAGE_KEYS = {
            ACCESS_TOKEN: 'tiktok_access_token',
            REFRESH_TOKEN: 'tiktok_refresh_token',
            TOKEN_EXPIRE_TIME: 'tiktok_token_expire_time',
            AUTH_INFO: 'tiktok_auth_info'
        };

        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[Test] ${message}`);
        }

        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
        }

        function checkUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');

            if (code) {
                log(`âœ… æ£€æµ‹åˆ°URLä¸­çš„codeå‚æ•°: ${code}`);
                updateStatus(`æ£€æµ‹åˆ°æˆæƒç : ${code}`, 'success');

                // æ¨¡æ‹Ÿä¿å­˜Token
                simulateTokenSave(code);

                // æ¸…é™¤URLå‚æ•°
                window.history.replaceState({}, document.title, window.location.pathname);
                log('âœ… å·²æ¸…é™¤URLä¸­çš„codeå‚æ•°');
            } else {
                log('â„¹ï¸ URLä¸­æ²¡æœ‰codeå‚æ•°');
                checkStoredToken();
            }
        }

        function simulateTokenSave(code) {
            // æ¨¡æ‹ŸAPIå“åº”
            const mockTokenData = {
                access_token: 'mock_access_token_' + Date.now(),
                refresh_token: 'mock_refresh_token_' + Date.now(),
                access_token_expire_in: 3600,
                open_id: 'mock_open_id',
                seller_name: 'æµ‹è¯•å–å®¶',
                seller_base_region: 'CN'
            };

            // ä¿å­˜åˆ°localStorage
            localStorage.setItem(STORAGE_KEYS.ACCESS_TOKEN, mockTokenData.access_token);
            localStorage.setItem(STORAGE_KEYS.REFRESH_TOKEN, mockTokenData.refresh_token);
            localStorage.setItem(STORAGE_KEYS.TOKEN_EXPIRE_TIME,
                String(Math.floor(Date.now() / 1000) + mockTokenData.access_token_expire_in));

            const authInfo = {
                open_id: mockTokenData.open_id,
                seller_name: mockTokenData.seller_name,
                seller_base_region: mockTokenData.seller_base_region,
                created_at: new Date().toISOString()
            };
            localStorage.setItem(STORAGE_KEYS.AUTH_INFO, JSON.stringify(authInfo));

            log(`âœ… Tokenå·²ä¿å­˜: ${mockTokenData.access_token.substring(0, 20)}...`);
            log(`âœ… Refresh Tokenå·²ä¿å­˜: ${mockTokenData.refresh_token.substring(0, 20)}...`);
            log(`âœ… Tokenå°†åœ¨ ${mockTokenData.access_token_expire_in} ç§’åè¿‡æœŸ`);
            updateStatus('âœ… æˆæƒæˆåŠŸ! Tokenå·²ä¿å­˜', 'success');

            // æ˜¾ç¤ºè®¤è¯ä¿¡æ¯
            setTimeout(() => {
                showStoredAuthInfo();
            }, 500);
        }

        function checkStoredToken() {
            const accessToken = localStorage.getItem(STORAGE_KEYS.ACCESS_TOKEN);
            const authInfo = localStorage.getItem(STORAGE_KEYS.AUTH_INFO);

            if (accessToken && authInfo) {
                log('âœ… æ£€æµ‹åˆ°å·²ä¿å­˜çš„Token');
                log(`ğŸ“¦ Access Token: ${accessToken.substring(0, 20)}...`);

                try {
                    const info = JSON.parse(authInfo);
                    log(`ğŸ‘¤ å–å®¶: ${info.seller_name}`);
                    log(`ğŸŒ åœ°åŒº: ${info.seller_base_region}`);
                    updateStatus(`å·²ç™»å½•: ${info.seller_name}`, 'success');
                } catch (e) {
                    log('âŒ è§£æè®¤è¯ä¿¡æ¯å¤±è´¥');
                    updateStatus('è®¤è¯ä¿¡æ¯æŸå', 'info');
                }
            } else {
                log('â„¹ï¸ æœªæ£€æµ‹åˆ°å·²ä¿å­˜çš„Token');
                updateStatus('æœªæˆæƒ', 'info');
            }
        }

        function showStoredAuthInfo() {
            const authInfo = localStorage.getItem(STORAGE_KEYS.AUTH_INFO);
            if (authInfo) {
                try {
                    const info = JSON.parse(authInfo);
                    log('ğŸ“‹ è®¤è¯ä¿¡æ¯:');
                    log(`  - å–å®¶åç§°: ${info.seller_name}`);
                    log(`  - Open ID: ${info.open_id}`);
                    log(`  - åœ°åŒº: ${info.seller_base_region}`);
                    log(`  - åˆ›å»ºæ—¶é—´: ${info.created_at}`);
                } catch (e) {
                    log('âŒ è§£æè®¤è¯ä¿¡æ¯å¤±è´¥');
                }
            } else {
                log('â„¹ï¸ æ²¡æœ‰å­˜å‚¨çš„è®¤è¯ä¿¡æ¯');
            }
        }

        function simulateAuthCallback() {
            const testCode = 'test_code_' + Date.now();
            const newUrl = window.location.pathname + '?code=' + testCode;
            window.location.href = newUrl;
        }

        function showLocalStorage() {
            log('ğŸ“¦ localStorageå†…å®¹:');
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('tiktok_')) {
                    const value = localStorage.getItem(key);
                    if (value.length > 50) {
                        log(`  - ${key}: ${value.substring(0, 50)}...`);
                    } else {
                        log(`  - ${key}: ${value}`);
                    }
                }
            }
        }

        function clearLocalStorage() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰TikTokç›¸å…³çš„localStorageæ•°æ®å—?')) {
                Object.values(STORAGE_KEYS).forEach(key => {
                    localStorage.removeItem(key);
                });
                log('ğŸ—‘ï¸ å·²æ¸…é™¤æ‰€æœ‰è®¤è¯æ•°æ®');
                updateStatus('å·²æ¸…é™¤æ‰€æœ‰è®¤è¯æ•°æ®', 'info');
            }
        }

        function testTokenExpiry() {
            const expireTime = localStorage.getItem(STORAGE_KEYS.TOKEN_EXPIRE_TIME);
            if (expireTime) {
                const now = Math.floor(Date.now() / 1000);
                const remaining = parseInt(expireTime) - now;
                const minutes = Math.floor(remaining / 60);

                if (remaining > 0) {
                    log(`â° Tokenå‰©ä½™æœ‰æ•ˆæ—¶é—´: ${minutes} åˆ†é’Ÿ (${remaining} ç§’)`);
                    updateStatus(`Tokenå°†åœ¨ ${minutes} åˆ†é’Ÿåè¿‡æœŸ`, 'success');
                } else {
                    log('âŒ Tokenå·²è¿‡æœŸ');
                    updateStatus('Tokenå·²è¿‡æœŸ', 'info');
                }
            } else {
                log('â„¹ï¸ æ²¡æœ‰Tokenè¿‡æœŸæ—¶é—´ä¿¡æ¯');
            }
        }

        function manualGetToken() {
            const code = document.getElementById('testCode').value.trim();
            if (code) {
                log(`ğŸ“ æ‰‹åŠ¨è¾“å…¥æˆæƒç : ${code}`);
                simulateTokenSave(code);
            } else {
                alert('è¯·è¾“å…¥æˆæƒç ');
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥
        document.addEventListener('DOMContentLoaded', function() {
            log('ğŸš€ é¡µé¢åŠ è½½å®Œæˆ');
            checkUrlParams();
        });

        console.log('%cğŸ§ª æˆæƒæµç¨‹æµ‹è¯•é¡µé¢å·²å°±ç»ª', 'font-size: 16px; color: #667eea; font-weight: bold;');
        console.log('ä½¿ç”¨æ­¤é¡µé¢æµ‹è¯•:');
        console.log('1. URLå‚æ•°è‡ªåŠ¨æ£€æµ‹');
        console.log('2. Tokenä¿å­˜åˆ°localStorage');
        console.log('3. Tokenè¿‡æœŸæ£€æŸ¥');
        console.log('4. è®¤è¯ä¿¡æ¯æ¢å¤');
    </script>
</body>
</html>
